// Generated by CoffeeScript 1.9.1
(function() {
  var ECpageClass, Page;

  ECpageClass = (function() {
    var root;

    root = {};

    ECpageClass.prototype._page_name = "";

    ECpageClass.prototype._item_info = {};

    ECpageClass.prototype._platform = "";

    ECpageClass.prototype._listview_data = {
      pullable: false,
      hasFooterDivider: true,
      hasHeaderDivider: true,
      dividerHeight: 0,
      dividerColor: "#EBEBEB",
      data: [
        {
          viewType: "ListViewCellLine",
          _rightLayoutSize: 0,
          _leftLayoutSize: 40,
          centerTitle: "正在加载......",
          hasFooterDivider: "false"
        }
      ]
    };

    ECpageClass.prototype._constructor = function(_page_name1) {
      this._page_name = _page_name1;
      root = this;
      this.prepareForInitView();
      $A().page().widget(this._page_name + "_ListViewBase_0").data(JSON.stringify(this._listview_data));
      $A().page().widget(this._page_name + "_ListViewBase_0").onItemInnerClick(function(data) {
        return root.onItemInnerClick(data);
      });
      $A().page().widget(this._page_name + "_ListViewBase_0").onItemClick(function(data) {
        return root.onItemClick(data);
      });
      $A().page().onCreated(function() {
        return root.onCreated();
      });
      return this.getParams();
    };

    function ECpageClass(_page_name) {
      this._constructor(_page_name);
    }

    ECpageClass.prototype.onCreated = function() {
      if ((root._platform != null) && root._platform === "ios") {
        $A().page().widget(this._page_name + "_ListViewBase_0").refreshData(JSON.stringify(this._listview_data));
      }
      return this.getArticle();
    };

    ECpageClass.prototype.onItemClick = function(data) {
      var item;
      item = this._listview_data.data[data.position];
      if (item.viewType === "ListViewCellImage") {
        return $A().app().fullImage({
          imageurl: item.image.imageSrc,
          params: {}
        });
      }
    };

    ECpageClass.prototype.onItemInnerClick = function(data) {
      var item;
      item = this._listview_data.data[data.position];
      if ((item._type != null) && item._type === "back") {
        return $A().app().closePage();
      }
    };

    ECpageClass.prototype.onResume = function() {};

    ECpageClass.prototype.prepareForInitView = function() {
      return $A().app().platform().then(function(platform) {
        return root._platform = platform;
      });
    };

    ECpageClass.prototype.getParams = function() {
      return $A().page().param("info").then(function(data) {
        var reg, reg1;
        reg = new RegExp("\r\n", "g");
        reg1 = new RegExp("\t", "g");
        return root._item_info = JSON.parse(data.replace(reg, "\\r\\n").replace(reg1, "\\t"));
      });
    };

    ECpageClass.prototype.getArticle = function() {
      $A().page().widget("ActionBar").title({
        title: "" + this._item_info.item_colum
      });
      return $A().app().callApi({
        method: "courses/indices/knowledges/detail",
        item_id: this._item_info.id,
        cacheTime: 0
      }).then(function(data) {
        if (data.errors != null) {
          if (data.errors[0].error_num != null) {
            return $A().app().makeToast("网络状态不好，请重新加载");
          } else {
            return $A().app().makeToast("没有网络");
          }
        } else {
          return root.showArticle(data);
        }
      });
    };

    ECpageClass.prototype.showArticle = function(content_info) {
      var contents, i, item, j, len;
      this._listview_data.data = [];
      contents = [];
      this.data = [];
      this._listview_data.data.push({
        viewType: "ListViewCellArticleTitle",
        headTitle: "" + this._item_info.title,
        subheadTitle: typeof this._item_info.subtitle !== "undefined" && (("" + this._item_info.subtitle) != null) ? "" + this._item_info.subtitle : "",
        hasFooterDivider: "false"
      });
      content_info.content = content_info.content.trim();
      contents = content_info.content.split("[img]");
      if ((content_info.image_cover.url != null) && content_info.image_cover.url !== "") {
        this._listview_data.data.push({
          viewType: "ListViewCellImage",
          image: {
            imageType: "imageServer",
            imageSize: "xlarge",
            imageSrc: content_info.image_cover.url
          },
          hasFooterDivider: "false"
        });
      }
      if (contents.length === 1) {
        this._listview_data.data.push({
          viewType: "ListViewCellLine",
          centerBottomdes2: content_info.content.replace(/(\n\r){1,}/g, "").replace(/(\r\n)/g, "\r\n\r\n"),
          hasFooterDivider: "false"
        });
      } else {
        for (i = j = 0, len = contents.length; j < len; i = ++j) {
          item = contents[i];
          if ((item != null) && item.trim() !== "") {
            this._listview_data.data.push({
              viewType: "ListViewCellLine",
              centerBottomdes2: item.replace(/(\n\r){1,}/g, "").replace(/(\r\n)/g, "\r\n\r\n"),
              hasFooterDivider: "false"
            });
          }
          if ((i + 1 < contents.length) && content_info.attachments && content_info.attachments.length > 0 && (content_info.attachments[i] != null) && (content_info.attachments[i].attachment.url != null) && content_info.attachments[i].attachment.url !== "") {
            this._listview_data.data.push({
              viewType: "ListViewCellImage",
              image: {
                imageType: "imageServer",
                imageSize: "xlarge",
                imageSrc: content_info.attachments[i].attachment.url
              },
              hasFooterDivider: "false"
            });
          }
        }
      }
      this._listview_data.data.push({
        viewType: "ListViewCellButton",
        btnTitle: "返 回",
        btnType: "ok",
        _type: "back"
      });
      return $A().page().widget(this._page_name + "_ListViewBase_0").refreshData(JSON.stringify(this._listview_data));
    };

    return ECpageClass;

  })();

  Page = new ECpageClass("page_course_article_detail");

}).call(this);
