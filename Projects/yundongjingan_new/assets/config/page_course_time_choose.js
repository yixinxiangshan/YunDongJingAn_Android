// Generated by CoffeeScript 1.9.0
(function() {
  var ECpageClass;

  ECpageClass = (function() {
    var root;

    root = {};

    ECpageClass.prototype._page_name = "";

    ECpageClass.prototype._item_info = {};

    ECpageClass.prototype._platform = "";

    ECpageClass.prototype._listview_data = {
      pullable: false,
      hasFooterDivider: false,
      hasHeaderDivider: false,
      dividerHeight: 0,
      dividerColor: "#cccccc",
      data: [
        {
          viewType: "ListViewCellLine",
          _rightLayoutSize: 0,
          _leftLayoutSize: 60,
          centerTitle: "正在加载......"
        }
      ]
    };

    ECpageClass.prototype._constructor = function(_at__page_name) {
      this._page_name = _at__page_name;
      root = this;
      this.prepareForInitView();
      $A().page().widget(this._page_name + "_ListViewBase_0").data(JSON.stringify(this._listview_data));
      $A().page().widget(this._page_name + "_ListViewBase_0").onItemInnerClick(function(data) {
        return root.onItemInnerClick(data);
      });
      $A().page().widget(this._page_name + "_ListViewBase_0").onItemClick(function(data) {
        return root.onItemClick(data);
      });
      return $A().page().onCreated(function() {
        return root.onCreated();
      });
    };

    function ECpageClass(_page_name) {
      this._constructor(_page_name);
    }

    ECpageClass.prototype.onCreated = function() {
      if ((root._platform != null) && root._platform === "ios") {
        $A().page().widget(this._page_name + "_ListViewBase_0").refreshData(JSON.stringify(this._listview_data));
      }
      return root.getNetResourse();
    };

    ECpageClass.prototype.onItemClick = function(data) {
      var item, position;
      item = root._listview_data.data[data.position];
      position = data.position;
      if (root._listview_data.data[data.position]._type === "_item") {
        return $A().app().showDatepickerConfirm({
          ok: "确定",
          cancel: "取消",
          defaultDay: item.item_setting.time_content != null ? item.rightDes : item.item_setting.suggest_date,
          title: root._listview_data.data[data.position].centerTitle
        }).then(function(data) {
          var date_time;
          if (data.state === "ok") {
            $A().page("page_home").param({
              key: "_setting_changed",
              value: "true"
            });
            $A().lrucache().set({
              key: "has_add_notifications",
              value: "false"
            });
            $A().app().showLoadingDialog({
              content: "正在设置" + item.centerTitle
            });
            date_time = data.value;
            return $A().app().callApi({
              method: "users/courses/set_day",
              fav_id: item.item_setting.fav_id,
              day_type: item.item_setting.day_type,
              date_time: date_time,
              cacheTime: 0
            }).then(function(data) {
              var day_type;
              if ((data != null) && (data.success != null) && data.success === true) {
                day_type = "" + item.item_setting.day_type;
                $A().lrucache().get("fav_id_arr").then(function(data) {
                  var fav_id_arr;
                  fav_id_arr = {};
                  fav_id_arr = (data != null) && data !== "" ? JSON.parse(data) : {};
                  fav_id_arr["" + item.item_setting.fav_id].info["" + day_type] = date_time;
                  return $A().lrucache().set({
                    key: "fav_id_arr",
                    value: JSON.stringify(fav_id_arr)
                  });
                });
                root._listview_data.data[position].rightDes = date_time;
                $A().page().widget(root._page_name + "_ListViewBase_0").refreshData(JSON.stringify(root._listview_data));
                return $A().page().setTimeout("400").then(function() {
                  return $A().app().closeLoadingDialog();
                });
              } else if ((data != null) && (data.errors != null)) {
                if (data.errors === "没有网络") {
                  return $A().app().makeToast("请打开网络,然后再设置或更改时间。");
                } else {
                  return $A().app().makeToast("网络环境不好，请重试！");
                }
              }
            });
          }
        });
      }
    };

    ECpageClass.prototype.onItemInnerClick = function(data) {
      return $A().page().setTimeout("100").then(function() {
        return $A().app().closePage();
      });
    };

    ECpageClass.prototype.onResume = function() {};

    ECpageClass.prototype.onResult = function() {};

    ECpageClass.prototype.prepareForInitView = function() {
      return $A().app().platform().then(function(platform) {
        return root._platform = platform;
      });
    };

    ECpageClass.prototype.getNetResourse = function() {
      root._listview_data.data = [];
      return $A().app().callApi({
        method: "users/courses/times",
        cacheTime: 0
      }).then(function(res) {
        var i, item, listdata, time, _i, _j, _len, _len1, _ref, _ref1;
        _ref = res.items;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          item = _ref[_i];
          root._listview_data.data.push({
            viewType: "ListViewCellGroupTitle",
            textTitle: item.course_title,
            _type: "_title"
          });
          _ref1 = item.set_times;
          for (i = _j = 0, _len1 = _ref1.length; _j < _len1; i = ++_j) {
            time = _ref1[i];
            listdata = [];
            listdata = {
              viewType: "ListViewCellLine",
              _rightLayoutSize: 0,
              _leftLayoutSize: 20,
              _bottomDivider: {
                imageType: "assets",
                imageSize: "fitSize",
                imageSrc: "webview/images/icon/default/divider.png"
              },
              rightImage: {
                imageType: "assets",
                imageSize: "fitSize",
                imageSrc: "webview/images/icon/default/listview_right.png"
              },
              centerTitle: time.time_name + "时间",
              rightDes: time.content != null ? time.content : "未设置",
              item_setting: {
                suggest_date: time.suggest_date,
                fav_id: item.fav_id,
                course_title: item.course_title,
                day_type: time.time_type,
                name: time.time_name,
                time_content: time.content
              },
              _type: "_item",
              hasFooterDivider: "true"
            };
            if (i === 0) {
              listdata._topDivider = {
                imageType: "assets",
                imageSize: "fitSize",
                imageSrc: "webview/images/icon/default/divider.png"
              };
            }
            root._listview_data.data.push(listdata);
          }
        }
        root._listview_data.data.push({
          viewType: "ListViewCellLine"
        });
        root._listview_data.data.push({
          viewType: "ListViewCellButton",
          btnTitle: "确 定",
          btnType: "ok"
        });
        return $A().page().setTimeout("300").then(function() {
          return $A().page().widget(root._page_name + "_ListViewBase_0").refreshData(JSON.stringify(root._listview_data));
        });
      });
    };

    return ECpageClass;

  })();

  new ECpageClass("page_course_time_choose");

}).call(this);
